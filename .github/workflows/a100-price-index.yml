name: A100 GPU Price Index Pipeline

on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Install Chrome for Selenium
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Run all A100 scrapers
        run: python run_all_a100_scrapers.py
        timeout-minutes: 30

      - name: Calculate A100 index
        run: python calculate_a100_index.py

      - name: Push to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python push_to_supabase.py

      - name: Push to Contract
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
        run: |
          PRICE=$(python -c "import json; print(json.load(open('a100_weighted_index.json'))['final_index_price'])")
          python push_to_contract.py --price $PRICE

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: price-data
          path: |
            a100_combined_prices.json
            a100_weighted_index.json
          retention-days: 30
